<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>âš™ï¸ × ×™×”×•×œ</title>
  <link rel="stylesheet" href="assets/css/styles.css" />
  <style>
    :root {
      --nav-h: 64px;
    }

    html,
    body,
    button,
    input,
    select,
    textarea {
      font-family: Calibri, "Segoe UI", Arial, sans-serif !important;
    }

    body {
      background: #121212;
      color: #ddd;
      margin: 0;
    }

    header.topbar {
      background: #f1c40f;
      color: #000;
      font-weight: bold;
      padding: 15px;
      font-size: 1.6em;
      text-align: center;
      border-bottom: 2px solid #333;
    }

    .container {
      max-width: 520px;
      margin: auto;
      padding: 0 14px calc(var(--nav-h) + 20px);
      text-align: right;
    }

    /* Tabs */
    .tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 12px 0;
      flex-wrap: wrap;
    }

    .tab-btn {
      background: #2c2c2c;
      color: #eee;
      border: none;
      padding: 12px 18px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
      min-width: 160px;
      font-size: 1.05em;
      transition: transform .05s ease-in-out;
    }

    .tab-btn:active {
      transform: scale(0.98);
    }

    .tab-btn.active {
      background: #f1c40f;
      color: #000;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .panel-title {
      color: #f1c40f;
      font-weight: 800;
      font-size: 1.15em;
    }

    /* Buttons */
    .btn {
      background: #f1c40f;
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      color: #000;
      font-weight: 800;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: transform .05s ease-in-out, opacity .2s;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn[disabled] {
      opacity: .6;
      cursor: default;
    }

    .btn-secondary {
      background: #2c2c2c;
      color: #eee;
    }

    .btn-icon {
      padding: 6px 9px;
      line-height: 1;
      font-size: .95em;
      border-radius: 8px;
      background: #333;
      color: #fff;
      min-width: auto;
    }

    .icon-btn {
      background: #2b2b2b;
      color: #eee;
      border: 1px solid #444;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
    }

    .icon-btn:hover {
      background: #3a3a3a;
    }

    .btn-save {
      background: #f1c40f;
      color: #000;
    }

    .btn-save .ico {
      order: -1;
    }

    .btn-cancel {
      background: #2c2c2c;
      color: #eee;
    }

    /* Task card */
    .task-card {
      position: relative;
      background: #1f1f1f;
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 14px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .35);
      border: 1px solid #2b2b2b;
    }

    .task-title {
      font-size: 1.15em;
      font-weight: 700;
      margin-bottom: 6px;
      color: #f1c40f;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .title-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .task-meta {
      font-size: 1em;
      color: #ddd;
      margin-bottom: 8px;
    }

    .task-notes {
      margin-top: 6px;
      color: #f1c40f;
      background: rgba(241, 196, 15, .08);
      border: 1px dashed rgba(241, 196, 15, .35);
      padding: 6px 8px;
      border-radius: 6px;
      white-space: pre-wrap;
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
      align-items: center;
    }

    /* Edit */
    .edit-area {
      margin-top: 8px;
    }

    .edit-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-top: 4px;
    }

    .edit-row input,
    .edit-row textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #1f1f1f;
      color: #ddd;
      font-size: 1em;
    }

    .edit-row textarea {
      min-height: 70px;
    }

    input[type="date"]::-webkit-calendar-picker-indicator,
    input[type="time"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
    }

    /* Responses */
    .resp-wrap {
      margin-top: 10px;
      border-top: 1px solid #333;
      padding-top: 10px;
    }

    .resp-header {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-direction: row;
    }

    .resp-header .resp-toggle {
      flex: 1 1 auto;
      min-width: 0;
      height: 40px;
      border-radius: 10px;
      font-weight: 700;
      padding-inline: 12px;
    }

    .resp-header .btn-icon {
      flex: 0 0 auto;
      width: 40px;
      min-width: 40px;
      height: 40px;
      padding: 0;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    @media (min-width:640px) {
      .resp-header .resp-toggle {
        height: 42px;
      }

      .resp-header .btn-icon {
        width: 42px;
        min-width: 42px;
        height: 42px;
      }
    }

    .resp-body {
      display: none;
      background: #151515;
      border: 1px solid #2a2a2a;
      border-radius: 10px;
      padding: 10px;
      margin-top: 8px;
    }

    .resp-open .resp-body {
      display: block;
    }

    .resp-title {
      color: #f1c40f;
      font-weight: 700;
      margin: 0 0 6px;
    }

    .resp-list {
      font-size: .85em;
      line-height: 1.3;
    }

    .resp-list ol {
      margin: 2px 0 6px;
      padding-left: 20px;
    }

    .resp-list li {
      margin-bottom: 2px;
    }

    /* Loader */
    #loader {
      position: fixed;
      inset: 0;
      display: none;
      justify-content: center;
      align-items: center;
      background: rgba(0, 0, 0, .45);
      z-index: 9999;
    }

    .loader {
      border: 6px solid #333;
      border-top: 6px solid #f1c40f;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin .7s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg)
      }
    }

    /* Bottom nav */
    .nav-btn.is-disabled {
      opacity: .45;
      pointer-events: none;
      filter: grayscale(.2);
    }
  </style>
</head>

<body>
  <!-- Global loader -->
  <div id="loader">
    <div class="loader"></div>
  </div>

  <div id="page" style="display:none;">
    <header class="topbar">âš™ï¸ × ×™×”×•×œ</header>

    <main class="container">
      <div class="tabs">
        <button class="tab-btn active" data-tab="tasks">ğŸ—‚ï¸ ××©×™××•×ª</button>
        <button class="tab-btn" data-tab="members">ğŸ‘¥ × ×™×”×•×œ ××©×ª×ª×¤×™×</button>
      </div>

      <!-- Tasks -->
      <section id="tab-tasks" class="tab-panel active">
        <div class="panel-header">
          <div class="panel-title">×¨×©×™××ª ××©×™××•×ª</div>
          <button class="btn" onclick="location.href='add-task.html'">â• ×”×•×¡×¤×ª ××©×™××”</button>
        </div>
        <div id="tasksList"></div>
      </section>

      <!-- Members -->
      <section id="tab-members" class="tab-panel">
        <div class="panel-header">
          <div class="panel-title">× ×™×”×•×œ ××©×ª×ª×¤×™×</div>
        </div>
        <div style="background:#1f1f1f;border:1px solid #2b2b2b;border-radius:12px;padding:12px;">
          <div class="add-member-row" style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
            <input id="newMemberName" type="text" placeholder="×©× ×—×“×©"
              style="flex:1;padding:10px;border-radius:8px;border:1px solid #333;background:#1f1f1f;color:#ddd;box-sizing:border-box;">
            <button class="btn-secondary" id="addMemberBtn">â• ×”×•×¡×£</button>
          </div>
          <div id="membersList" class="pills" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
        </div>
      </section>
    </main>
  </div>

  <!-- Spacer -->
  <div id="nav-spacer" aria-hidden="true"></div>

  <!-- Bottom nav -->
  <div class="bottom-nav" id="bottomNav">
    <button class="nav-btn" onclick="location.href='home.html'">ğŸ  ×‘×™×ª</button>
    <button class="nav-btn" data-admin>âš™ï¸ × ×™×”×•×œ</button>
    <button class="nav-btn" data-logout title="×™×¦×™××”">ğŸšª ×™×¦×™××”</button>
  </div>

  <script>
    // ×’×œ×•×‘×œ×™×™×
    window.gIsAdmin = false;
    window.gDisplayName = '';

    function setNavPadding() {
      const nav = document.getElementById('bottomNav'); if (!nav) return;
      const h = Math.ceil(nav.getBoundingClientRect().height);
      document.documentElement.style.setProperty('--nav-h', h + 'px');
      const spacer = document.getElementById('nav-spacer');
      if (spacer) spacer.style.height = `calc(${h}px + env(safe-area-inset-bottom,0px))`;
    }
    addEventListener('DOMContentLoaded', setNavPadding);
    addEventListener('resize', setNavPadding);
    addEventListener('orientationchange', setNavPadding);

    function setGlobalLoading(on) {
      const l = document.getElementById('loader');
      if (l) l.style.display = on ? 'flex' : 'none';
    }
  </script>

  <script src="assets/js/api.js"></script>

  <script>
    /* ===== ×¢×–×¨×™× ===== */
    const esc = s => String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\"/g, "&quot;").replace(/'/g, "&#039;");
    function formatDate(v) { const d = new Date(v); return isNaN(d) ? v : d.toLocaleDateString('he-IL', { year: 'numeric', month: '2-digit', day: '2-digit' }); }
    function formatTime(v) { const d = new Date(v); if (!isNaN(d)) return d.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }); if (/^\d{1,2}:\d{2}$/.test(v)) return v; return v || ''; }
    function hebDayName(v) { const d = new Date(v); const days = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª']; return isNaN(d) ? '' : days[d.getDay()]; }

    // × ×¨××•×œ ×œ×ª××™××•×ª ××•×œ ×”×©×¨×ª
    function normDate(x) {
      if (!x) return '';
      const s = String(x).trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if (m) return `${m[3]}-${m[2]}-${m[1]}`;
      const d = new Date(s); if (!isNaN(d)) return d.toISOString().slice(0, 10);
      return s;
    }
    function normTime(x) {
      if (!x) return '';
      const s = String(x).trim();
      if (/^\d{1,2}:\d{2}$/.test(s)) { const [h, m] = s.split(':'); return `${String(h).padStart(2, '0')}:${m}`; }
      const d = new Date(s); if (!isNaN(d)) { const hh = String(d.getHours()).padStart(2, '0'); const mm = String(d.getMinutes()).padStart(2, '0'); return `${hh}:${mm}`; }
      return '';
    }

    function toDateInputValue(s) { return normDate(s); }
    function toTimeInputValue(s) { return normTime(s); }

    /* ===== ×ª×’×•×‘×•×ª ===== */
    function matchRecord(taskObj, r) {
      // ×”×ª×××” ×¡×œ×—× ×™×ª: ××©×™××” ×—×™×™×‘×ª; ×ª××¨×™×š ×—×™×™×‘; ×©×¢×” × ×‘×—× ×ª ×¨×§ ×× ×§×™×™××ª ×‘×©× ×™ ×”×¦×“×“×™×
      const tTask = String(taskObj.××©×™××” || '').trim();
      const tDate = normDate(taskObj.×ª××¨×™×š);
      const tTime = normTime(taskObj.×©×¢×”);
      if (String(r.××©×™××” || '').trim() !== tTask) return false;
      if (normDate(r.×ª××¨×™×š) !== tDate) return false;
      const rTime = normTime(r.×©×¢×”);
      if (tTime && rTime && tTime !== rTime) return false;
      return true;
    }

    function groupResponsesForTask(taskObj, responses, allMembers) {
      const filtered = (responses || []).filter(r => matchRecord(taskObj, r));
      const grouped = {}, counts = {}, responded = new Set();
      filtered.forEach(r => {
        const status = String(r.×¡×˜×˜×•×¡ || '').trim();
        const name = String(r.×©× || '').trim();
        const note = r.×”×¢×¨×” == null ? '' : String(r.×”×¢×¨×”).trim();
        if (!status || !name) return;
        responded.add(name);
        (grouped[status] ||= []).push(note ? `${name} â€“ ${note.replace(/\s+/g, ' ')}` : name);
        counts[status] = (counts[status] || 0) + 1;
      });
      Object.keys(grouped).forEach(k => grouped[k].sort((a, b) => String(a).localeCompare(String(b), 'he')));
      const notResponded = (allMembers || []).filter(m => !responded.has(m));
      return { grouped, counts, notResponded };
    }

    function makeShareText(taskObj, grouped, notResponded, counts) {
      const title = `${taskObj.××©×™××”} â€¢ ${formatDate(taskObj.×ª××¨×™×š)} â€¢ ${formatTime(taskObj.×©×¢×”)}`;
      const lines = [`*${title}*`, ''];
      const keys = Array.from(new Set([...Object.keys(grouped || {}), ...Object.keys(counts || {})]))
        .sort((a, b) => String(a).localeCompare(String(b), 'he'));

      if (window.gIsAdmin && Object.keys(grouped || {}).length) {
        let n = 1;
        keys.forEach(k => {
          const arr = grouped[k] || [];
          const cnt = counts[k] || arr.length || 0;
          if (!cnt) return;
          if (arr.length) {
            lines.push(`*${k}:*`);
            arr.forEach(item => lines.push(`${n++}. ${item}`));
            lines.push('');
            lines.push(`×¡×”"×› ${k}: ${arr.length}`);
            lines.push('');
          } else {
            lines.push(`*${k}:* ${cnt}`);
          }
        });
      } else {
        keys.forEach(k => {
          const c = counts[k] || (grouped[k]?.length || 0) || 0;
          if (c) lines.push(`*${k}:* ${c}`);
        });
      }
      lines.push(`×¡×”"×› ×œ× ×”×’×™×‘×•: ${notResponded?.length || 0}`);
      return lines.join('\n');
    }

    function renderResponsesBlock(taskObj, grouped, counts, notResponded, idx) {
      const title = `${taskObj.××©×™××”} â€¢ ${formatDate(taskObj.×ª××¨×™×š)} â€¢ ${formatTime(taskObj.×©×¢×”)}`;
      const keys = Array.from(new Set([...Object.keys(grouped || {}), ...Object.keys(counts || {})]))
        .sort((a, b) => String(a).localeCompare(String(b), 'he'));

      const sections = []; let run = 1;
      if (window.gIsAdmin) {
        keys.forEach(k => {
          const arr = grouped[k] || [];
          const cnt = counts[k] || arr.length || 0;
          if (!cnt) return;
          if (arr.length) {
            sections.push(`
              <section>
                <div class="h"><b>*${esc(k)}:*</b></div>
                <ol start="${run}">${arr.map(v => `<li>${esc(v)}</li>`).join('')}</ol>
              </section>
            `);
            run += arr.length;
          }
        });
      }

      const nrCount = Array.isArray(notResponded) ? notResponded.length : 0;
      const notRespHtml = window.gIsAdmin
        ? (notResponded && notResponded[0]
          ? `<section><div class="h"><b>*×œ× ×”×’×™×‘×• â“:*</b> (${nrCount})</div><ul>${notResponded.map(n => `<li>${esc(n)}</li>`).join('')}</ul></section>`
          : `<section><div class="h"><b>*×¡×”"×› ×œ× ×”×’×™×‘×• â“:*</b> ${nrCount}</div></section>`)
        : '';

      const summary = [];
      keys.forEach(k => {
        const c = counts[k] || (grouped[k]?.length || 0) || 0;
        if (c) summary.push(`<div class="h"><b>*×¡×”"×› ${esc(k)}:*</b> ${c}</div>`);
      });
      summary.push(`<div class="h"><b>*×¡×”"×› ×œ× ×”×’×™×‘×•:*</b> ${nrCount}</div>`);

      const id = `resp_${idx}`;
      const share = makeShareText(taskObj, grouped, notResponded, counts);

      return `
        <div class="resp-wrap" id="${id}">
          <div class="resp-header">
            <button class="btn btn-secondary resp-toggle" onclick="toggleResp('${id}')">â–¶ï¸ ×¨×©×™××”</button>
            <button class="btn btn-icon" onclick="copyShare('${encodeURIComponent(share)}')" title="×”×¢×ª×§">ğŸ“‹</button>
          </div>
          <div class="resp-body">
            <div class="resp-title">${esc(title)}</div>
            <div class="resp-list">
              ${window.gIsAdmin ? sections.join('') : ''}
              ${window.gIsAdmin ? notRespHtml : ''}
              <section>${summary.join('')}</section>
            </div>
          </div>
        </div>
      `;
    }

    function toggleResp(id) {
      const el = document.getElementById(id); if (!el) return;
      el.classList.toggle('resp-open');
      const b = el.querySelector('.resp-toggle');
      if (b) b.textContent = el.classList.contains('resp-open') ? 'ğŸ”½ ×¨×©×™××”' : 'â–¶ï¸ ×¨×©×™××”';
    }
    async function copyShare(encoded) {
      const txt = decodeURIComponent(encoded);
      try { await navigator.clipboard.writeText(txt); alert('×”×•×¢×ª×§ ×œ×œ×•×—'); }
      catch {
        const ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); ta.remove(); alert('×”×•×¢×ª×§ ×œ×œ×•×— (fallback)');
      }
    }

    /* ===== Data ===== */
    let gData = { tasks: [], responses: [], members: [] };

    async function loadAll() {
      const data = await (API?.getInitData?.({ force: true }) ?? {});
      gData.tasks = data.tasks || [];
      gData.responses = data.responses || data.Responses || [];
      gData.members = data.members || data.Members || [];
      return data;
    }

    /* ===== Render Members ===== */
    function renderMembers() {
      const host = document.getElementById('membersList'); host.innerHTML = '';
      gData.members.forEach(name => {
        const pill = document.createElement('span');
        pill.style.cssText = 'display:inline-flex;align-items:center;gap:8px;background:#1f1f1f;border:1px solid #2b2b2b;color:#ddd;border-radius:999px;padding:6px 10px;';
        pill.innerHTML = `<span>${esc(name)}</span><button class="pill-del" style="appearance:none;border:none;background:#2c2c2c;color:#eee;border-radius:999px;padding:4px 8px;cursor:pointer;font-size:.95em;">ğŸ—‘ï¸</button>`;
        pill.querySelector('.pill-del').addEventListener('click', async () => {
          if (!confirm(`×œ××—×•×§ ××ª "${name}"?`)) return;
          setGlobalLoading(true);
          try {
            await API.removeMember({ name });
            await loadAll(); renderMembers();
          } finally { setGlobalLoading(false); }
        });
        host.appendChild(pill);
      });
    }

    /* ===== Render Tasks ===== */
    function renderTasks() {
      const host = document.getElementById('tasksList');
      const tasks = [...gData.tasks].sort((a, b) => new Date(a.×ª××¨×™×š) - new Date(b.×ª××¨×™×š));
      if (!tasks.length) { host.innerHTML = '<p style="color:#aaa;">××™×Ÿ ××©×™××•×ª</p>'; return; }

      host.innerHTML = tasks.map((t, i) => {
        const { grouped, counts, notResponded } = groupResponsesForTask(t, gData.responses, gData.members);
        const resp = renderResponsesBlock(t, grouped, counts, notResponded, i);
        const meta = `${formatDate(t.×ª××¨×™×š)} â€¢ ${hebDayName(t.×ª××¨×™×š)} â€¢ ×©×¢×” ${formatTime(t.×©×¢×”)}`;
        const notes = t.×“×’×©×™× ? `<div class="task-notes">ğŸ“Œ ${esc(t.×“×’×©×™×)}</div>` : '';
        const dateVal = toDateInputValue(t.×ª××¨×™×š);
        const timeVal = toTimeInputValue(t.×©×¢×”);

        return `
          <div class="task-card"
            data-task="${esc(t.××©×™××”)}"
            data-date="${esc(dateVal)}"
            data-time="${esc(timeVal)}"
            data-options='${esc(t.××¤×©×¨×•×™×•×ª || "[]")}'>
            <div class="task-title">
              <span>${i + 1}. ${esc(t.××©×™××”)}</span>
              <div class="title-actions">
                <button class="btn-icon btn-edit" title="×¢×¨×•×š">âœï¸</button>
                <button class="btn-icon trash" title="××—×§">ğŸ—‘ï¸</button>
              </div>
            </div>
            <div class="task-meta">${meta}</div>
            ${notes}
            <div class="edit-area" style="display:none;">
              <div class="edit-row">
                <input type="text" class="inp-name" value="${esc(t.××©×™××”)}" placeholder="×©× ×”××©×™××”">
                <input type="date" class="inp-date" value="${esc(dateVal)}">
                <input type="time" class="inp-time" value="${esc(timeVal)}">
                <textarea class="inp-notes" placeholder="×“×’×©×™× / ×¤×¨×˜×™ ××™×¨×•×¢">${esc(t.×“×’×©×™× || "")}</textarea>
              </div>
              <div class="actions">
                <button class="btn btn-cancel">×‘×˜×œ</button>
                <button class="btn btn-save"><span class="ico">ğŸ’¾</span><span>×©××•×¨</span></button>
              </div>
            </div>
            ${resp}
          </div>
        `;
      }).join("");

      // Wire events
      host.querySelectorAll('.task-card').forEach(card => {
        const oldTask = card.dataset.task;
        const oldDate = card.dataset.date;
        const oldTime = card.dataset.time;
        const options = card.dataset.options || "[]";

        function _normDateForServer(s) { return normDate(s); }
        function _normTimeForServer(s) { return normTime(s); }

        // Delete (×‘×˜×•×—, ×›×•×œ×œ × ×™×¡×™×•×Ÿ ×¢× ×•×‘×œ×™ ×©×¢×”)
        card.querySelector('.trash').addEventListener('click', async () => {
          if (!confirm(`×œ××—×•×§ ××ª "${oldTask}"? ×–×” ×™××—×§ ×’× ××ª ×›×œ ×”×ª×’×•×‘×•×ª ×”××©×•×™×›×•×ª.`)) return;
          setGlobalLoading(true);
          try {
            try {
              await API.removeTask({ task: String(oldTask).trim(), date: _normDateForServer(oldDate), time: _normTimeForServer(oldTime) });
            } catch (e1) {
              // × ×¡×™×•×Ÿ ×©× ×™ ×‘×œ×™ ×©×¢×”
              await API.removeTask({ task: String(oldTask).trim(), date: _normDateForServer(oldDate) });
            }
            await loadAll(); renderTasks();
          } catch (e) {
            console.error('removeTask failed', e);
            alert('××—×™×§×” × ×›×©×œ×”. ×‘×“×•×§ ×©×”××©×™××”/×ª××¨×™×š/×©×¢×” ×ª×•×××™× ×œ×’×™×œ×™×•×Ÿ.');
          } finally {
            setGlobalLoading(false);
          }
        });

        // Edit toggles
        const editBtn = card.querySelector('.btn-edit');
        const editArea = card.querySelector('.edit-area');
        editBtn.addEventListener('click', () => { editArea.style.display = 'block'; });
        card.querySelector('.btn-cancel').addEventListener('click', () => { editArea.style.display = 'none'; });

        // Save (×¢×¨×™×›×” ×‘×œ×™ ×œ××‘×“ ×ª×’×•×‘×•×ª)
        card.querySelector('.btn-save').addEventListener('click', async () => {
          const newTask = card.querySelector('.inp-name').value.trim();
          const newDate = _normDateForServer(card.querySelector('.inp-date').value);
          const newTime = _normTimeForServer(card.querySelector('.inp-time').value);
          const newNotes = card.querySelector('.inp-notes').value.trim();
          if (!newTask || !newDate) { alert('×©× ××©×™××” ×•×ª××¨×™×š ×—×•×‘×”'); return; }

          const payload = {
            oldTask, oldDate: _normDateForServer(oldDate), oldTime: _normTimeForServer(oldTime),
            newTask, newDate, newTime, options, notes: newNotes
          };

          setGlobalLoading(true);
          try {
            if (typeof API.updateTask === 'function') {
              // ×“×¨×š ××•××œ×¦×ª â€“ ×”×©×¨×ª ×™×¢×“×›×Ÿ ×’× ××ª Responses
              await API.updateTask(payload);
            } else {
              // × ×¤×™×œ×” ×—×›××”: ×©×™××•×¨ ×ª×’×•×‘×•×ª ×™×“× ×™
              // 1) ××•×¡×¤×™× ×ª×’×•×‘×•×ª ×™×©× ×•×ª
              const toMove = (gData.responses || []).filter(r => matchRecord({ ××©×™××”: oldTask, ×ª××¨×™×š: oldDate, ×©×¢×”: oldTime }, r));
              // 2) ××•×—×§×™× ××ª ×”××©×™××” ×”×™×©× ×” (×™××—×§ ×’× ××ª ×”×ª×’×•×‘×•×ª ×©×œ×”)
              try {
                await API.removeTask({ task: oldTask, date: payload.oldDate, time: payload.oldTime });
              } catch (e1) {
                // ×× ×œ× ×”×¦×œ×™×— ×¢× ×©×¢×” â€“ ×× ×¡×™× ×‘×œ×™ ×©×¢×”
                await API.removeTask({ task: oldTask, date: payload.oldDate });
              }
              // 3) ×™×•×¦×¨×™× ××©×™××” ×—×“×©×”
              await API.addTask({ '××©×™××”': newTask, '×ª××¨×™×š': newDate, '×©×¢×”': newTime, '××¤×©×¨×•×™×•×ª': options, '×“×’×©×™×': newNotes });
              // 4) ××©×—×–×¨×™× ×ª×’×•×‘×•×ª ×ª×—×ª ×”××¤×ª×—×•×ª ×”×—×“×©×™×
              for (const r of toMove) {
                await API.postResponse({
                  task: newTask,
                  date: newDate,
                  time: newTime,
                  member: r.×©×,
                  status: r.×¡×˜×˜×•×¡,
                  note: r.×”×¢×¨×” || ''
                });
              }
            }
            // ×¨×¢× ×•×Ÿ ×•×“×¤×“×•×£ × ×§×™
            await loadAll(); renderTasks();
            editArea.style.display = 'none';
          } catch (err) {
            console.error(err);
            alert('×©××™×¨×” × ×›×©×œ×”. × ×¡×” ×©×•×‘ ××• ×‘×“×•×§ ×©×”Ö¾API ×–××™×Ÿ (updateTask).');
          } finally {
            setGlobalLoading(false);
          }
        });
      });
    }

    /* ===== Tabs ===== */
    addEventListener('click', (e) => {
      const btn = e.target.closest('.tab-btn'); if (!btn) return;
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id === 'tab-' + btn.dataset.tab));
      setNavPadding();
    });

    /* ===== Members actions ===== */
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('addMemberBtn').addEventListener('click', async () => {
        const inp = document.getElementById('newMemberName');
        const name = inp.value.trim(); if (!name) return inp.reportValidity();
        setGlobalLoading(true);
        try {
          await API.addMember({ name });
          inp.value = '';
          await loadAll(); renderMembers();
        } finally { setGlobalLoading(false); }
      });
    });

    /* ===== Guard + Init ===== */
    async function init() {
      try {
        await loadAll();
        renderTasks();
        renderMembers();
      } catch (e) {
        console.error(e);
        alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×');
      } finally {
        document.getElementById('page').style.display = 'block';
        setGlobalLoading(false);
        setNavPadding();
      }
    }

    (async function guardAdmin() {
      try {
        setGlobalLoading(true);
        const hasToken = !!(API?.Auth?.token || localStorage.getItem('token'));
        if (!hasToken) { location.href = 'index.html?force=1&next=admin'; return; }

        const me = await API.me();
        if (!me?.success || me.role !== 'admin') { location.href = 'home.html?denied=1'; return; }
        window.gIsAdmin = true;
        window.gDisplayName = me.displayName || me.username || '';

        const top = document.querySelector('header.topbar');
        if (top) {
          const span = document.createElement('span');
          span.style.cssText = 'font-size:.8em;margin-inline-start:8px;color:#000;opacity:.85;';
          span.textContent = window.gDisplayName ? `(${window.gDisplayName} â€¢ ×× ×”×œ)` : `(×× ×”×œ)`;
          top.appendChild(span);
        }

        // Logout button
        const logoutBtn = document.querySelector('.bottom-nav .nav-btn[data-logout]');
        if (logoutBtn && !logoutBtn._wired) {
          logoutBtn.addEventListener('click', async () => {
            try { await API.logout(); } catch { }
            location.href = 'index.html?force=1';
          });
          logoutBtn._wired = true;
        }
        // Admin btn (×‘××¡×š × ×™×”×•×œ ××™×Ÿ ×¦×•×¨×š), ×¨×§ ××‘×˜×œ ×“×™×¡××‘×œ
        const adminBtn = document.querySelector('.bottom-nav .nav-btn[data-admin]');
        if (adminBtn) { adminBtn.classList.remove('is-disabled'); adminBtn.title = '× ×™×”×•×œ'; }

        await init();
      } catch (e) {
        console.error('admin guard error:', e);
        location.href = 'home.html?err=auth';
      }
    })();
  </script>
</body>

</html>