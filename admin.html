<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>âš™ï¸ × ×™×”×•×œ</title>

  <!-- No-Cache -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="assets/css/styles.css" />
  <!-- ×©×•××¨×™× ×¨×§ ×—×™××•× ×—×™×‘×•×¨×™ ×¨×©×ª (×œ× prefetch/preload ×œ×§×‘×¦×™×) -->
  <link rel="preconnect" href="https://script.google.com">
  <link rel="dns-prefetch" href="https://script.google.com">
  <link rel="preconnect" href="https://script.googleapis.com">
  <link rel="dns-prefetch" href="https://script.googleapis.com">

  <style>
    :root {
      --nav-h: 64px;
    }

    html,
    body,
    button,
    input,
    select,
    textarea {
      font-family: Calibri, "Segoe UI", Arial, sans-serif !important;
    }

    body {
      background: #121212;
      color: #ddd;
      margin: 0;
    }

    header.topbar {
      background: #f1c40f;
      color: #000;
      font-weight: 800;
      padding: 14px;
      font-size: 1.6em;
      text-align: center;
      border-bottom: 2px solid #333;
    }

    .container {
      max-width: 560px;
      margin: auto;
      padding: 12px 14px calc(var(--nav-h) + 20px);
      text-align: right;
    }

    .tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 12px 0;
      flex-wrap: wrap;
    }

    .bottom-nav .nav-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  text-align: center;
}


    .tab-btn {
      background: #2c2c2c;
      color: #eee;
      border: none;
      padding: 12px 18px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 800;
      min-width: 160px;
      font-size: 1.05em;
    }

    .tab-btn.active {
      background: #f1c40f;
      color: #000;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .panel-title {
      color: #f1c40f;
      font-weight: 800;
      font-size: 1.1em;
    }

    .btn {
      background: #f1c40f;
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      color: #000;
      font-weight: 800;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-secondary {
      background: #2c2c2c;
      color: #eee;
    }

    .btn[disabled] {
      opacity: .6;
      cursor: default;
    }

    .btn-icon {
      padding: 6px 9px;
      line-height: 1;
      font-size: .95em;
      border-radius: 8px;
      background: #333;
      color: #fff;
      min-width: auto;
    }

    .task-card {
      background: #1f1f1f;
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 14px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .35);
      border: 1px solid #2b2b2b;
    }

    .task-title {
      font-size: 1.15em;
      font-weight: 700;
      margin-bottom: 6px;
      color: #f1c40f;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .title-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .task-meta {
      font-size: 1em;
      color: #ddd;
      margin-bottom: 8px;
    }

    .task-notes {
      margin-top: 6px;
      color: #f1c40f;
      background: rgba(241, 196, 15, .08);
      border: 1px dashed rgba(241, 196, 15, .35);
      padding: 6px 8px;
      border-radius: 6px;
      white-space: pre-wrap;
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
      align-items: center;
    }

    .edit-area {
      margin-top: 8px;
    }

    .edit-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-top: 4px;
    }

    .edit-row input,
    .edit-row textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #1f1f1f;
      color: #ddd;
      font-size: 1em;
    }

    .edit-row textarea {
      min-height: 70px;
    }

    input[type="date"]::-webkit-calendar-picker-indicator,
    input[type="time"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
    }

    .resp-wrap {
      margin-top: 10px;
      border-top: 1px solid #333;
      padding-top: 10px;
    }

    .resp-header {
      display: grid;
      grid-template-columns: 1fr auto;
      column-gap: 8px;
      align-items: center;
      width: 100%;
    }

    .resp-header .resp-toggle {
      width: 100%;
    }

    .resp-header .btn-icon {
      width: auto;
    }

    .resp-body {
      display: none;
      background: #151515;
      border: 1px solid #2a2a2a;
      border-radius: 10px;
      padding: 10px;
      margin-top: 8px;
    }

    .resp-open .resp-body {
      display: block;
    }

    .resp-title {
      color: #f1c40f;
      font-weight: 700;
      margin: 0 0 6px;
    }

    .resp-list {
      font-size: .9em;
      line-height: 1.3;
    }

    .resp-list ol {
      margin: 2px 0 6px;
      padding-left: 20px;
    }

    .resp-list li {
      margin-bottom: 2px;
    }

    #loader {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #121212;
    }

    .loader {
      border: 6px solid #333;
      border-top: 6px solid #f1c40f;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin .7s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .nav-btn.is-disabled {
      opacity: .45;
      pointer-events: none;
      filter: grayscale(.2);
    }

    #busy {
      position: fixed;
      inset: 0;
      display: none;
      background: rgba(0, 0, 0, .35);
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    #busy .loader {
      width: 42px;
      height: 42px;
      border-width: 5px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #1f1f1f;
      border: 1px solid #2b2b2b;
      color: #ddd;
      border-radius: 999px;
      padding: 6px 10px;
      margin: 4px;
    }

    .pill .pill-del {
      appearance: none;
      border: none;
      background: #2c2c2c;
      color: #eee;
      border-radius: 999px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: .95em;
    }
  </style>
  <!DOCTYPE html>
  <html lang="he" dir="rtl">

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>âš™ï¸ × ×™×”×•×œ</title>

    <!-- No-Cache -->
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="preconnect" href="https://script.google.com">
    <link rel="dns-prefetch" href="https://script.google.com">
    <link rel="preconnect" href="https://script.googleapis.com">
    <link rel="dns-prefetch" href="https://script.googleapis.com">

    <style>
      /* ×©××¨×ª×™ ××ª ×›×œ ×”Ö¾CSS ×©×œ×š ×›××• ×©×”×™×” */
      /* ... */
    </style>
  </head>

<body>
  <div id="loader">
    <div class="loader"></div>
  </div>
  <div id="busy">
    <div class="loader"></div>
  </div>

  <div id="page" style="display:none;">
    <header class="topbar">âš™ï¸ × ×™×”×•×œ</header>
    <main class="container">
      <div class="tabs">
        <button class="tab-btn active" data-tab="tasks">ğŸ—‚ï¸ ××©×™××•×ª</button>
        <button class="tab-btn" data-tab="members">ğŸ‘¥ × ×™×”×•×œ ××©×ª×ª×¤×™×</button>
      </div>

      <section id="tab-tasks" class="tab-panel active">
        <div class="panel-header">
          <div class="panel-title">×¨×©×™××ª ××©×™××•×ª</div>
          <button class="btn" onclick="location.href='add-task.html'">â• ×”×•×¡×¤×ª ××©×™××”</button>
        </div>
        <div id="tasksList"></div>
      </section>

      <section id="tab-members" class="tab-panel">
        <div class="panel-header">
          <div class="panel-title">× ×™×”×•×œ ××©×ª×ª×¤×™×</div>
        </div>

        <div style="background:#1f1f1f;border:1px solid #2b2b2b;border-radius:12px;padding:12px;">

          <!-- ×˜×•×¤×¡ ×™×¦×™×¨×ª ××©×ª××© ×—×“×© -->
          <form id="newUserForm" style="display:grid;gap:10px;grid-template-columns:1fr 1fr;align-items:end;">
            <div style="grid-column:1 / -1;color:#f1c40f;font-weight:800;">×™×¦×™×¨×ª ××©×ª××© ×—×“×©</div>

            <label>Username
              <input type="text" name="username" placeholder="yonil" pattern="[A-Za-z0-9]{3,32}"
                title="×¨×§ ××•×ª×™×•×ª ×œ×˜×™× ×™×•×ª ×•××¡×¤×¨×™×, 3â€“32 ×ª×•×•×™×" required
                style="width:100%;padding:10px;border-radius:8px;border:1px solid #333;background:#1f1f1f;color:#ddd;" />

              <label>×©× ×ª×¦×•×’×”
                <input name="display_name" required placeholder="×™×•× ×™ ×—×™ ×œ×•×™"
                  style="width:100%;padding:10px;border-radius:8px;border:1px solid #333;background:#1f1f1f;color:#ddd;">
              </label>

              <label>Password
                <input name="password" type="text" required minlength="4" placeholder="×œ×¤×—×•×ª 4 ×ª×•×•×™×"
                  style="width:100%;padding:10px;border-radius:8px;border:1px solid #333;background:#1f1f1f;color:#ddd;">
              </label>

              <label>×ª×¤×§×™×“
                <select name="role"
                  style="width:100%;padding:10px;border-radius:8px;border:1px solid #333;background:#1f1f1f;color:#ddd;">
                  <option value="user">user</option>
                  <option value="admin">admin</option>
                </select>
              </label>

              <label style="display:flex;align-items:center;gap:8px;">
                <input name="active" type="checkbox" checked> ×¤×¢×™×œ
              </label>

              <button class="btn btn-secondary" style="grid-column:1 / -1;justify-self:start;">â• ×¦×•×¨ ××©×ª××©</button>
          </form>

          <hr style="border:none;border-top:1px solid #333;margin:12px 0;">

          <!-- ×¨×©×™××ª ××©×ª××©×™× -->
          <div id="membersList" class="pills" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
        </div>
      </section>

    </main>
  </div>

  <div id="nav-spacer" aria-hidden="true"></div>
  <div class="bottom-nav" id="bottomNav">
    <button class="nav-btn" onclick="location.href='home.html'">ğŸ  ×‘×™×ª</button>
    <button class="nav-btn" data-admin>âš™ï¸ × ×™×”×•×œ</button>
    <button class="nav-btn" data-logout title="×™×¦×™××”">ğŸšª ×™×¦×™××”</button>
  </div>

  <script src="assets/js/api.js?v=9"></script>
  <script>
    window.gIsAdmin = false;
    window.gDisplayName = '';

    function setNavPadding() {
      const nav = document.getElementById('bottomNav'); if (!nav) return;
      const h = Math.ceil(nav.getBoundingClientRect().height);
      document.documentElement.style.setProperty('--nav-h', h + 'px');
      const spacer = document.getElementById('nav-spacer');
      if (spacer) spacer.style.height = `calc(${h}px + env(safe-area-inset-bottom,0px))`;
    }
    addEventListener('DOMContentLoaded', setNavPadding);
    addEventListener('resize', setNavPadding);
    addEventListener('orientationchange', setNavPadding);



    /* ===== Utils ===== */
    const esc = s => String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;').replace(/'/g, '&#039;');
    const formatDate = v => { const d = new Date(v); return isNaN(d) ? v : d.toLocaleDateString('he-IL', { year: 'numeric', month: '2-digit', day: '2-digit' }); };
    const formatTime = v => { const t = new Date(v); if (!isNaN(t)) return t.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }); if (/^\d{1,2}:\d{2}$/.test(v)) return v; return v || ''; };
    const hebDayName = v => { const d = new Date(v); const days = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª']; return isNaN(d) ? '' : days[d.getDay()]; };
    const normDate = x => { const s = String(x || '').trim(); if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s; const d = new Date(s); return !isNaN(d) ? d.toISOString().slice(0, 10) : s; };
    const normTime = x => { const s = String(x || '').trim(); const m = s.match(/^(\d{1,2}):(\d{2})/); return m ? (('0' + m[1]).slice(-2)) + ':' + m[2] : ''; };

    // ===== Data =====
    let gData = { tasks: [], responses: [], members: [], responseCounts: [], responseCountsByDay: [] };

    async function loadAll(force = false) {
      const data = await (API?.getInitData?.({ force }) || {});
      gData.tasks = data.tasks || [];
      gData.responses = data.responses || [];
      gData.responseCounts = data.responseCounts || [];
      gData.responseCountsByDay = data.responseCountsByDay || [];

      // ×œ×§×—×ª ××ª ×”××—×¨×•×–×•×ª ×-initdata
      const fromInit = data.members || [];

      // ×œ×”×‘×™× ××™×“×¢ ××œ× ×-getMembers
      const m = await API.getMembers();
      const full = m.members || [];

      // ×œ×¢×©×•×ª ×”×ª×××” â€“ ×œ×”×©××™×¨ ×¨×§ ××™ ×©××•×¤×™×¢ ×‘-initdata
      gData.members = full.filter(x => fromInit.includes(x.display_name));

      return gData;
    }

    /* ===== Members ===== */
    function renderMembers() {
      const host = document.getElementById('membersList');
      host.innerHTML = '';

      const members = (gData.members || []).map(m =>
        (typeof m === 'string') ? { username: m, display_name: m, role: 'user', active: true } : m
      );

      const byName = (a, b) => (a.display_name || a.username).localeCompare(b.display_name || b.username, 'he');
      const admins = members.filter(m => m.role === 'admin' && m.active !== false).sort(byName);
      const users = members.filter(m => m.role !== 'admin' && m.active !== false).sort(byName);

      const makeGroup = (title, arr) => {
        if (!arr.length) return;
        const box = document.createElement('div');
        box.innerHTML = `
        <h3 style="color:#f1c40f;margin:8px 0;">${title} (${arr.length})</h3>
        <div class="pills"></div>`;
        const pills = box.querySelector('.pills');
        arr.forEach(m => pills.appendChild(makePill(m)));
        host.appendChild(box);
      };

      makeGroup('â­ ××“××™× ×™×', admins);
      makeGroup('××©×ª××©×™×', users);
    }

    function makePill(m) {
      const pill = document.createElement('span');
      pill.className = 'pill';
      pill.innerHTML = `
      <span>${(m.display_name || m.username)}</span>
      <button class="pill-del" title="××—×§">ğŸ—‘ï¸</button>`;
      pill.querySelector('.pill-del').addEventListener('click', async () => {
        if (!confirm('×œ××—×•×§ ××ª "' + (m.display_name || m.username) + '"?')) return;
        showBusy(true);
        try {
          await API.removeMember({ username: m.username });
          await refreshAndRender();
        } catch (e) {
          console.error(e);
          alert('××—×™×§×” × ×›×©×œ×”');
        } finally {
          showBusy(false);
        }
      });
      return pill;
    }

    /* ===== Responses (×¨×©×™××”+×”×¢×ª×§×”) ===== */
    function groupResponsesForTask(taskObj, data, opts = {}) {
      const showNames = !!opts.showNames;
      const tTask = String(taskObj.××©×™××” || '').trim();
      const tDate = normDate(taskObj.×ª××¨×™×š);
      const tTime = normTime(taskObj.×©×¢×”);

      // âœ… ×”×¤×™×›×” ×©×œ ×›×œ ×”××©×ª×ª×¤×™× ×œ××—×¨×•×–×•×ª ×©××•×ª
      const allMembers = (data.members || [])
        .map(m => {
          if (typeof m === "string") return m;
          if (typeof m === "object" && m !== null) {
            return m.display_name || m.username || "";
          }
          return "";
        })
        .map(s => String(s).trim())
        .filter(Boolean);

      const responses = showNames ? (data.responses || []) : [];
      const summary = data.responseCounts || [];

      const grouped = {};
      const countsOnly = {};
      const responded = new Set();

      if (showNames) {
        responses.forEach(r => {
          if (r.××©×™××” !== tTask) return;
          const status = String(r.×¡×˜×˜×•×¡ || '').trim();
          const name = String(r.×©× || '').trim();
          const note = String(r.×”×¢×¨×” || '').trim();
          if (!status || !name) return;
          responded.add(name);
          const label = note ? `${name} â€“ ${note}` : name;
          (grouped[status] ||= []).push(label);
        });
      }

      if (!showNames) {
        summary
          .filter(s => s["××©×™××”"] === taskObj.××©×™××” && s["×ª××¨×™×š"] === taskObj.×ª××¨×™×š && s["×©×¢×”"] === taskObj.×©×¢×”)
          .forEach(s => { countsOnly[s["×¡×˜×˜×•×¡"]] = Number(s.count); });
      } else {
        Object.entries(grouped).forEach(([k, arr]) => { countsOnly[k] = arr.length; });
      }

      let notResponded = [];
      if (showNames) {
        // âœ… ××—×–×™×¨ ×¨×§ ×©××•×ª ×××™×ª×™×™×
        notResponded = allMembers.filter(name => name && !responded.has(name));
      } else {
        const totalAnswered = Object.values(countsOnly).reduce((a, b) => a + b, 0);
        const missing = Math.max(0, allMembers.length - totalAnswered);
        notResponded = Array(missing).fill(""); // ×œ××©×ª××© ×¨×’×™×œ ×œ× ××¦×™×’ ×©××•×ª
      }

      return { grouped, countsOnly, notResponded };
    }

    function renderResponsesBlock(taskObj, grouped, countsOnly, idx, notResponded) {
      const title = `${taskObj.××©×™××”} â€¢ ${formatDate(taskObj.×ª××¨×™×š)} â€¢ ${formatTime(taskObj.×©×¢×”)} â€¢ ${hebDayName(taskObj.×ª××¨×™×š)}`;
      const wrapId = `resp_${idx}`;
      const shareText = makeShareText(taskObj, grouped, notResponded, countsOnly, { includeNames: gIsAdmin });

      let sections = '';
      let index = 1;
      Object.entries(grouped).forEach(([k, arr]) => {
        if (!arr.length) return;
        sections += `<section><div class="h"><b>${esc(k)}:</b></div><ol start="${index}">${arr.map(n => `<li>${esc(n)}</li>`).join('')}</ol></section>`;
        index += arr.length;
      });

      if (notResponded.length) {
        sections += `<section><div class="h"><b>×œ× ×”×’×™×‘×• â“:</b> (${notResponded.length})</div><ol start="${index}">${notResponded.map(n => `<li>${esc(n)}</li>`).join('')}</ol></section>`;
      }

      const summaryLines = Object.entries(countsOnly).map(([k, v]) => `<div class="h"><b>×¡×”"×› ${esc(k)}:</b> ${v}</div>`);
      summaryLines.push(`<div class="h"><b>×¡×”"×› ×œ× ×”×’×™×‘×•:</b> ${notResponded.length}</div>`);

      return `
  <div class="resp-wrap" id="${wrapId}">
    <div class="resp-header">
      <button class="btn btn-secondary resp-toggle" onclick="toggleResp('${wrapId}')">â–¶ï¸ ×¨×©×™××”</button>
      <button class="btn btn-icon" onclick="copyShare('${encodeURIComponent(shareText)}')" title="×”×¢×ª×§">ğŸ“‹</button>
    </div>
    <div class="resp-body">
      <div class="resp-title">${esc(title)}</div>
      <div class="resp-list">
        ${sections}
        <section>${summaryLines.join('')}</section>
      </div>
    </div>
  </div>`;
    }

    function makeShareText(taskObj, grouped, notResponded, countsOnly, { includeNames = false } = {}) {
      const title = `${taskObj.××©×™××”} â€¢ ${formatDate(taskObj.×ª××¨×™×š)} â€¢ ${formatTime(taskObj.×©×¢×”)} â€¢ ${hebDayName(taskObj.×ª××¨×™×š)}`;
      const lines = [`*${title}*`, ''];

      let i = 1;
      if (includeNames) {
        Object.entries(grouped).forEach(([k, arr]) => {
          if (arr.length) {
            lines.push(`*${k}:*`);
            arr.forEach(n => lines.push(`${i++}. ${n}`));
            lines.push('');
          }
        });

        if (notResponded.length) {
          lines.push('*×œ× ×”×’×™×‘×• â“:*');
          notResponded.forEach(n => lines.push(`${i++}. ${n}`));
          lines.push('');
        }
      }

      lines.push('*×¡×™×›×•×:*');
      Object.keys(countsOnly).forEach(k => lines.push(`- ×¡×”"×› ${k}: ${countsOnly[k]}`));
      lines.push(`- ×¡×”"×› ×œ× ×”×’×™×‘×•: ${notResponded.length}`);

      return lines.join("\n");
    }

    async function copyShare(encoded) {
      const txt = decodeURIComponent(encoded);
      try {
        await navigator.clipboard.writeText(txt);
        alert('×”×•×¢×ª×§ ×œ×œ×•×—');
      } catch {
        const ta = document.createElement('textarea');
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
        alert('×”×•×¢×ª×§ ×œ×œ×•×— (fallback)');
      }
    }

    function toggleResp(id) {
      const el = document.getElementById(id); if (!el) return;
      el.classList.toggle('resp-open');
      const btn = el.querySelector('.resp-toggle');
      if (btn) btn.textContent = el.classList.contains('resp-open') ? 'ğŸ”½ ×¨×©×™××”' : 'â–¶ï¸ ×¨×©×™××”';
    }

    /* ===== Tasks ===== */
    function renderTasks() {
      const host = document.getElementById('tasksList');
      const tasks = [...(gData.tasks || [])].sort((a, b) => new Date(b.×ª××¨×™×š) - new Date(a.×ª××¨×™×š));
      if (!tasks.length) {
        host.innerHTML = '<p style="color:#aaa;">××™×Ÿ ××©×™××•×ª</p>';
        return;
      }

      host.innerHTML = tasks.map((t, i) => {
        const meta = `${formatDate(t.×ª××¨×™×š)} â€¢ ${hebDayName(t.×ª××¨×™×š)} â€¢ ×©×¢×” ${formatTime(t.×©×¢×”)}`;
        const notes = t.×“×’×©×™× ? `<div class="task-notes">ğŸ“Œ ${esc(t.×“×’×©×™×)}</div>` : '';
        const { grouped, countsOnly, notResponded } = groupResponsesForTask(t, gData, { showNames: true });
        const respBlock = renderResponsesBlock(t, grouped, countsOnly, i, notResponded);

        return `
      <div class="task-card" 
           data-task="${esc(t.××©×™××”)}" 
           data-date="${esc(normDate(t.×ª××¨×™×š))}" 
           data-time="${esc(normTime(t.×©×¢×”))}" 
           data-options='${esc(t.××¤×©×¨×•×™×•×ª || "[]")}'>

        <div class="task-title">
          <span>${i + 1}. ${esc(t.××©×™××”)}</span>
          <div class="title-actions">
            <button class="btn-icon btn-edit">âœï¸</button>
            <button class="btn-icon trash">ğŸ—‘ï¸</button>
          </div>
        </div>

        <div class="task-meta">${meta}</div>
        ${notes}
        ${respBlock}

        <div class="edit-area" style="display:none;">
          <div class="edit-row">
            <input type="text" class="inp-name" value="${esc(t.××©×™××”)}">
            <input type="date" class="inp-date" value="${esc(normDate(t.×ª××¨×™×š))}">
            <input type="time" class="inp-time" value="${esc(normTime(t.×©×¢×”))}">
            <textarea class="inp-notes">${esc(t.×“×’×©×™× || "")}</textarea>
          </div>
          <div class="actions">
            <button class="btn btn-secondary btn-cancel">×‘×˜×œ</button>
            <button class="btn btn-save">ğŸ’¾ ×©××•×¨</button>
          </div>
        </div>
      </div>`;
      }).join("");

      // ğŸ¯ ××—×¨×™ ×©×”××©×™××•×ª × ×‘× ×• â€“ ×œ×—×‘×¨ ×××–×™× ×™×
      host.querySelectorAll('.task-card').forEach(card => {
        const oldTask = card.dataset.task;
        const oldDate = card.dataset.date;
        const oldTime = card.dataset.time;
        const options = card.dataset.options || "[]";

        // âœï¸ ×¢×¨×™×›×”
        card.querySelector('.btn-edit').addEventListener('click', () => {
          card.querySelector('.edit-area').style.display = 'block';
        });

        // âŒ ×‘×™×˜×•×œ
        card.querySelector('.btn-cancel').addEventListener('click', () => {
          card.querySelector('.edit-area').style.display = 'none';
        });

        // ğŸ—‘ï¸ ××—×™×§×”
        card.querySelector('.trash').addEventListener('click', async () => {
          if (!confirm(`×œ××—×•×§ ××ª "${oldTask}"?`)) return;
          showBusy(true);
          try {
            await API.removeTask({ task: oldTask, date: oldDate, time: oldTime });
            await refreshAndRender();
          } catch (e) {
            console.error('removeTask failed', e);
            alert('××—×™×§×” × ×›×©×œ×”');
          } finally {
            showBusy(false);
          }
        });

        // ğŸ’¾ ×©××™×¨×”
        card.querySelector('.btn-save').addEventListener('click', async () => {
          const newTask = card.querySelector('.inp-name').value.trim();
          const newDate = card.querySelector('.inp-date').value;
          const newTime = card.querySelector('.inp-time').value;
          const newNotes = card.querySelector('.inp-notes').value.trim();
          if (!newTask || !newDate) {
            alert('×©× ××©×™××” ×•×ª××¨×™×š ×—×•×‘×”');
            return;
          }
          const payload = { oldTask, oldDate, oldTime, options, newTask, newDate, newTime, notes: newNotes };
          showBusy(true);
          try {
            await API.updateTask(payload);
            await refreshAndRender();
          } catch (err) {
            console.error(err);
            alert('×©××™×¨×” × ×›×©×œ×”');
          } finally {
            showBusy(false);
          }
        });
      });
    }

    function showBusy(on) { const el = document.getElementById('busy'); if (el) el.style.display = on ? 'flex' : 'none'; }
    async function refreshAndRender() { await loadAll(true); renderTasks(); renderMembers(); setNavPadding(); }

    /* Tabs */
    addEventListener('click', e => {
      const btn = e.target.closest('.tab-btn'); if (!btn) return;
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id === 'tab-' + btn.dataset.tab));
      setNavPadding();
    });


    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('newUserForm');
      if (!form) return;

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(form);
        const payload = {
          username: String(fd.get('username') || '').trim().toLowerCase(),
          display_name: String(fd.get('display_name') || '').trim(),
          password: String(fd.get('password') || ''),
          role: String(fd.get('role') || 'user'),
          active: !!fd.get('active')
        };
        if (!payload.username || !payload.display_name || !payload.password) {
          alert('×™×© ×œ××œ× ×©× ××©×ª××©, ×©× ×ª×¦×•×’×” ×•×¡×™×¡××”'); return;
        }

        showBusy(true);
        try {
          const r = await API.addMember(payload);
          if (!r?.success) throw new Error(r?.error || 'addMember failed');
          form.reset();
          form.querySelector('select[name="role"]').value = 'user';
          form.querySelector('input[name="active"]').checked = true;
          await refreshAndRender();
          alert('âœ… ×”××©×ª××© × ×•×¦×¨ ×‘×”×¦×œ×—×”');
        } catch (err) {
          console.error(err);
          alert('âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ××©×ª××©: ' + (err.message || ''));
        } finally {
          showBusy(false);
        }
      });
    });

    /* Init Guard */
    (async function guardAdmin() {
      try {
        const me = await API.me();
        if (!me?.success || me.role !== 'admin') { location.href = 'home.html?denied=1'; return; }
        window.gIsAdmin = true; window.gDisplayName = me.displayName || me.username || '';
        await refreshAndRender();
      } catch (e) {
        console.error('admin guard error:', e);
        alert('admin guard error: ' + e.message); // ×–×× ×™ ×œ×‘×“×™×§×”
        // location.href='home.html?err=auth'; // ×ª×‘×˜×œ ×–×× ×™×ª
      }
      finally {
        document.getElementById('loader').style.display = 'none';
        document.getElementById('page').style.display = 'block';
        setNavPadding();
        const logoutBtn = document.querySelector('.bottom-nav .nav-btn[data-logout]');
        if (logoutBtn) {
          const hasToken = !!(API?.Auth?.token || localStorage.getItem('token'));
          logoutBtn.style.display = hasToken ? 'inline-flex' : 'none';
          if (!logoutBtn._wired) {
            logoutBtn.addEventListener('click', async () => {
              try { await API.logout(); } catch { }
              location.href = 'index.html?force=1';
            });
            logoutBtn._wired = true;
          }
        }
      }
    })();
  </script>
</body>

</html>