<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>⚙️ ניהול</title>

  <!-- No-Cache -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="assets/css/styles.css" />
  <!-- שומרים רק חימום חיבורי רשת (לא prefetch/preload לקבצים) -->
  <link rel="preconnect" href="https://script.google.com">
  <link rel="dns-prefetch" href="https://script.google.com">
  <link rel="preconnect" href="https://script.googleapis.com">
  <link rel="dns-prefetch" href="https://script.googleapis.com">

  <style>
    :root {
      --nav-h: 64px;
    }

    html,
    body,
    button,
    input,
    select,
    textarea {
      font-family: Calibri, "Segoe UI", Arial, sans-serif !important;
    }

    body {
      background: #121212;
      color: #ddd;
      margin: 0;
    }

    header.topbar {
      background: #f1c40f;
      color: #000;
      font-weight: 800;
      padding: 14px;
      font-size: 1.6em;
      text-align: center;
      border-bottom: 2px solid #333;
    }

    .container {
      max-width: 560px;
      margin: auto;
      padding: 12px 14px calc(var(--nav-h) + 20px);
      text-align: right;
    }

    .tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 12px 0;
      flex-wrap: wrap;
    }

    .tab-btn {
      background: #2c2c2c;
      color: #eee;
      border: none;
      padding: 12px 18px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 800;
      min-width: 160px;
      font-size: 1.05em;
    }

    .tab-btn.active {
      background: #f1c40f;
      color: #000;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .panel-title {
      color: #f1c40f;
      font-weight: 800;
      font-size: 1.1em;
    }

    .btn {
      background: #f1c40f;
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      color: #000;
      font-weight: 800;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-secondary {
      background: #2c2c2c;
      color: #eee;
    }

    .btn[disabled] {
      opacity: .6;
      cursor: default;
    }

    .btn-icon {
      padding: 6px 9px;
      line-height: 1;
      font-size: .95em;
      border-radius: 8px;
      background: #333;
      color: #fff;
      min-width: auto;
    }

    .task-card {
      background: #1f1f1f;
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 14px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .35);
      border: 1px solid #2b2b2b;
    }

    .task-title {
      font-size: 1.15em;
      font-weight: 700;
      margin-bottom: 6px;
      color: #f1c40f;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .title-actions {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .task-meta {
      font-size: 1em;
      color: #ddd;
      margin-bottom: 8px;
    }

    .task-notes {
      margin-top: 6px;
      color: #f1c40f;
      background: rgba(241, 196, 15, .08);
      border: 1px dashed rgba(241, 196, 15, .35);
      padding: 6px 8px;
      border-radius: 6px;
      white-space: pre-wrap;
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
      align-items: center;
    }

    .edit-area {
      margin-top: 8px;
    }

    .edit-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin-top: 4px;
    }

    .edit-row input,
    .edit-row textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #333;
      background: #1f1f1f;
      color: #ddd;
      font-size: 1em;
    }

    .edit-row textarea {
      min-height: 70px;
    }

    input[type="date"]::-webkit-calendar-picker-indicator,
    input[type="time"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
    }

    .resp-wrap {
      margin-top: 10px;
      border-top: 1px solid #333;
      padding-top: 10px;
    }

    .resp-header {
      display: grid;
      grid-template-columns: 1fr auto;
      column-gap: 8px;
      align-items: center;
      width: 100%;
    }

    .resp-header .resp-toggle {
      width: 100%;
    }

    .resp-header .btn-icon {
      width: auto;
    }

    .resp-body {
      display: none;
      background: #151515;
      border: 1px solid #2a2a2a;
      border-radius: 10px;
      padding: 10px;
      margin-top: 8px;
    }

    .resp-open .resp-body {
      display: block;
    }

    .resp-title {
      color: #f1c40f;
      font-weight: 700;
      margin: 0 0 6px;
    }

    .resp-list {
      font-size: .9em;
      line-height: 1.3;
    }

    .resp-list ol {
      margin: 2px 0 6px;
      padding-left: 20px;
    }

    .resp-list li {
      margin-bottom: 2px;
    }

    #loader {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #121212;
    }

    .loader {
      border: 6px solid #333;
      border-top: 6px solid #f1c40f;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin .7s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .nav-btn.is-disabled {
      opacity: .45;
      pointer-events: none;
      filter: grayscale(.2);
    }

    #busy {
      position: fixed;
      inset: 0;
      display: none;
      background: rgba(0, 0, 0, .35);
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    #busy .loader {
      width: 42px;
      height: 42px;
      border-width: 5px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #1f1f1f;
      border: 1px solid #2b2b2b;
      color: #ddd;
      border-radius: 999px;
      padding: 6px 10px;
      margin: 4px;
    }

    .pill .pill-del {
      appearance: none;
      border: none;
      background: #2c2c2c;
      color: #eee;
      border-radius: 999px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: .95em;
    }
  </style>
  <!DOCTYPE html>
  <html lang="he" dir="rtl">

  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>⚙️ ניהול</title>

    <!-- No-Cache -->
    <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="preconnect" href="https://script.google.com">
    <link rel="dns-prefetch" href="https://script.google.com">
    <link rel="preconnect" href="https://script.googleapis.com">
    <link rel="dns-prefetch" href="https://script.googleapis.com">

    <style>
      /* שמרתי את כל ה־CSS שלך כמו שהיה */
      /* ... */
    </style>
  </head>

<body>
  <div id="loader">
    <div class="loader"></div>
  </div>
  <div id="busy">
    <div class="loader"></div>
  </div>

  <div id="page" style="display:none;">
    <header class="topbar">⚙️ ניהול</header>
    <main class="container">
      <div class="tabs">
        <button class="tab-btn active" data-tab="tasks">🗂️ משימות</button>
        <button class="tab-btn" data-tab="members">👥 ניהול משתתפים</button>
      </div>

      <section id="tab-tasks" class="tab-panel active">
        <div class="panel-header">
          <div class="panel-title">רשימת משימות</div>
          <button class="btn" onclick="location.href='add-task.html'">➕ הוספת משימה</button>
        </div>
        <div id="tasksList"></div>
      </section>

      <section id="tab-members" class="tab-panel">
        <div class="panel-header">
          <div class="panel-title">ניהול משתתפים</div>
        </div>
        <div style="background:#1f1f1f;border:1px solid #2b2b2b;border-radius:12px;padding:12px;">
          <div class="add-member-row"
            style="display:flex;gap:8px;align-items:center;margin-bottom:10px;flex-wrap:wrap;">
            <input id="newMemberName" type="text" placeholder="שם חדש"
              style="flex:1;padding:10px;border-radius:8px;border:1px solid #333;background:#1f1f1f;color:#ddd;box-sizing:border-box;min-width:220px;">
            <button class="btn btn-secondary" id="addMemberBtn">➕ הוסף</button>
          </div>
          <div id="membersList" class="pills" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
        </div>
      </section>
    </main>
  </div>

  <div id="nav-spacer" aria-hidden="true"></div>
  <div class="bottom-nav" id="bottomNav">
    <button class="nav-btn" onclick="location.href='home.html'">🏠 בית</button>
    <button class="nav-btn" data-admin>⚙️ ניהול</button>
    <button class="nav-btn" data-logout title="יציאה">🚪 יציאה</button>
  </div>

  <script src="assets/js/api.js?v=9"></script>
  <script>
    window.gIsAdmin = false;
    window.gDisplayName = '';

    function setNavPadding() {
      const nav = document.getElementById('bottomNav'); if (!nav) return;
      const h = Math.ceil(nav.getBoundingClientRect().height);
      document.documentElement.style.setProperty('--nav-h', h + 'px');
      const spacer = document.getElementById('nav-spacer');
      if (spacer) spacer.style.height = `calc(${h}px + env(safe-area-inset-bottom,0px))`;
    }
    addEventListener('DOMContentLoaded', setNavPadding);
    addEventListener('resize', setNavPadding);
    addEventListener('orientationchange', setNavPadding);



    /* ===== Utils ===== */
    const esc = s => String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;').replace(/'/g, '&#039;');
    const formatDate = v => { const d = new Date(v); return isNaN(d) ? v : d.toLocaleDateString('he-IL', { year: 'numeric', month: '2-digit', day: '2-digit' }); };
    const formatTime = v => { const t = new Date(v); if (!isNaN(t)) return t.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }); if (/^\d{1,2}:\d{2}$/.test(v)) return v; return v || ''; };
    const hebDayName = v => { const d = new Date(v); const days = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת']; return isNaN(d) ? '' : days[d.getDay()]; };
    const normDate = x => { const s = String(x || '').trim(); if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s; const d = new Date(s); return !isNaN(d) ? d.toISOString().slice(0, 10) : s; };
    const normTime = x => { const s = String(x || '').trim(); const m = s.match(/^(\d{1,2}):(\d{2})/); return m ? (('0' + m[1]).slice(-2)) + ':' + m[2] : ''; };

    /* ===== Data ===== */
    let gData = { tasks: [], responses: [], members: [], responseCounts: [], responseCountsByDay: [] };
    async function loadAll(force = false) {
      const data = await (API?.getInitData?.({ force }) || {});
      gData.tasks = data.tasks || [];
      gData.responses = data.responses || [];
      gData.members = data.members || [];
      gData.responseCounts = data.responseCounts || [];
      gData.responseCountsByDay = data.responseCountsByDay || [];
      return gData;
    }

    /* ===== Members ===== */
    function renderMembers() {
      const host = document.getElementById('membersList'); host.innerHTML = '';
      (gData.members || []).forEach(name => {
        const pill = document.createElement('span'); pill.className = 'pill';
        pill.innerHTML = `<span>${esc(name)}</span><button class="pill-del">🗑️</button>`;
        pill.querySelector('.pill-del').addEventListener('click', async () => {
          if (!confirm('למחוק את "' + name + '"?')) return;
          showBusy(true);
          try { await API.removeMember({ name }); await refreshAndRender(); }
          catch (e) { console.error(e); alert('מחיקה נכשלה'); }
          finally { showBusy(false); }
        });
        host.appendChild(pill);
      });
    }

    /* ===== Responses (רשימה+העתקה) ===== */
    function groupResponsesForTask(taskObj, data, opts = {}) {
      const showNames = !!opts.showNames;
      const tTask = String(taskObj.משימה || '').trim();
      const tDate = normDate(taskObj.תאריך);
      const tTime = normTime(taskObj.שעה);

      const allMembers = (data.members || []).map(x => String(x || '').trim()).filter(Boolean);
      const responses = showNames ? (data.responses || []) : [];
      const summary = data.responseCounts || [];

      const grouped = {}, countsOnly = {}, responded = new Set();
      if (showNames) {
        responses.forEach(r => {
          if (r.משימה !== tTask) return;
          const status = String(r.סטטוס || '').trim();
          const name = String(r.שם || '').trim();
          const note = String(r.הערה || '').trim();
          if (!status || !name) return;
          responded.add(name);
          const label = note ? `${name} – ${note}` : name;
          (grouped[status] ||= []).push(label);
        });
      }
      if (!showNames) {
        summary.filter(s => s["משימה"] === tTask && s["תאריך"] === tDate && s["שעה"] === tTime)
          .forEach(s => { countsOnly[s["סטטוס"]] = Number(s.count); });
      } else {
        Object.entries(grouped).forEach(([k, arr]) => { countsOnly[k] = arr.length; });
      }

      let notResponded = [];
      if (showNames) {
        notResponded = allMembers.filter(m => !responded.has(m));
      } else {
        const totalAnswered = Object.values(countsOnly).reduce((a, b) => a + b, 0);
        const missing = Math.max(0, allMembers.length - totalAnswered);
        notResponded = Array(missing).fill('');
      }
      return { grouped, countsOnly, notResponded };
    }


    function makeShareText(taskObj, grouped, notResponded, countsOnly, { includeNames = false } = {}) {
      const title = `${taskObj.משימה} • ${formatDate(taskObj.תאריך)} • ${formatTime(taskObj.שעה)} • ${hebDayName(taskObj.תאריך)}`;
      const lines = [`*${title}*`, ''];

      Object.keys(countsOnly).forEach(k => {
        const total = countsOnly[k];
        if (includeNames && grouped[k]?.length) {
          lines.push(`*${k}:*`);
          grouped[k].forEach((n, i) => lines.push(`${i + 1}. ${n}`));
        } else {
          lines.push(`*${k}:* ${total}`);
        }
        lines.push('');
      });

      const nrCount = notResponded.length;
      if (includeNames && nrCount) {
        lines.push('*לא הגיבו ❓:*');
        notResponded.forEach((n, i) => lines.push(`${i + 1}. ${n}`));
        lines.push('');
      }

      lines.push('*סיכום:*');
      Object.keys(countsOnly).forEach(k => lines.push(`- סה"כ ${k}: ${countsOnly[k]}`));
      lines.push(`- סה"כ לא הגיבו: ${nrCount}`);

      return lines.join("\n");
    }

    async function copyShare(encoded) {
      const txt = decodeURIComponent(encoded);
      try {
        await navigator.clipboard.writeText(txt);
        alert('הועתק ללוח');
      } catch {
        const ta = document.createElement('textarea');
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
        alert('הועתק ללוח (fallback)');
      }
    }

    function renderResponsesBlock(taskObj, grouped, countsOnly, idx, notResponded) {
      const title = `${taskObj.משימה} • ${formatDate(taskObj.תאריך)} • ${formatTime(taskObj.שעה)} • ${hebDayName(taskObj.תאריך)}`;
      const wrapId = `resp_${idx}`;
      const shareText = makeShareText(taskObj, grouped, notResponded, countsOnly, { includeNames: true });

      let sections = '';
      Object.entries(grouped).forEach(([k, arr], i) => {
        if (!arr.length) return;
        sections += `<section><div class="h"><b>${esc(k)}:</b></div><ol start="${i + 1}">${arr.map(n => `<li>${esc(n)}</li>`).join('')}</ol></section>`;
      });
      if (notResponded.length) {
        sections += `<section><div class="h"><b>לא הגיבו ❓:</b> (${notResponded.length})</div><ol>${notResponded.map(n => `<li>${esc(n)}</li>`).join('')}</ol></section>`;
      }

      const summaryLines = Object.entries(countsOnly).map(([k, v]) => `<div class="h"><b>סה"כ ${esc(k)}:</b> ${v}</div>`);
      summaryLines.push(`<div class="h"><b>סה"כ לא הגיבו:</b> ${notResponded.length}</div>`);

      return `
  <div class="resp-wrap" id="${wrapId}">
    <div class="resp-header">
      <button class="btn btn-secondary resp-toggle" onclick="toggleResp('${wrapId}')">▶️ רשימה</button>
      <button class="btn btn-icon" onclick="copyShare('${encodeURIComponent(shareText)}')" title="העתק">📋</button>
    </div>
    <div class="resp-body">
      <div class="resp-title">${esc(title)}</div>
      <div class="resp-list">
        ${sections}
        <section>${summaryLines.join('')}</section>
      </div>
    </div>
  </div>`;
    }




    function toggleResp(id) {
      const el = document.getElementById(id); if (!el) return;
      el.classList.toggle('resp-open');
      const btn = el.querySelector('.resp-toggle');
      if (btn) btn.textContent = el.classList.contains('resp-open') ? '🔽 רשימה' : '▶️ רשימה';
    }

    /* ===== Tasks ===== */
    function renderTasks() {
      const host = document.getElementById('tasksList');
      const tasks = [...(gData.tasks || [])].sort((a, b) => new Date(b.תאריך) - new Date(a.תאריך));
      if (!tasks.length) { host.innerHTML = '<p style="color:#aaa;">אין משימות</p>'; return; }

      host.innerHTML = tasks.map((t, i) => {
        const meta = `${formatDate(t.תאריך)} • ${hebDayName(t.תאריך)} • שעה ${formatTime(t.שעה)}`;
        const notes = t.דגשים ? `<div class="task-notes">📌 ${esc(t.דגשים)}</div>` : '';
        const { grouped, countsOnly, notResponded } = groupResponsesForTask(t, gData, { showNames: true });
        const respBlock = renderResponsesBlock(t, grouped, countsOnly, i, notResponded);
        return `
        <div class="task-card">
          <div class="task-title">
            <span>${i + 1}. ${esc(t.משימה)}</span>
            <div class="title-actions">
              <button class="btn-icon btn-edit">✏️</button>
              <button class="btn-icon trash">🗑️</button>
            </div>
          </div>
          <div class="task-meta">${meta}</div>
          ${notes}
          ${respBlock}
          <div class="edit-area" style="display:none;"> ... </div>
        </div>`;
      }).join("");
    }

    function showBusy(on) { const el = document.getElementById('busy'); if (el) el.style.display = on ? 'flex' : 'none'; }
    async function refreshAndRender() { await loadAll(true); renderTasks(); renderMembers(); setNavPadding(); }

    /* Tabs */
    addEventListener('click', e => {
      const btn = e.target.closest('.tab-btn'); if (!btn) return;
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.toggle('active', p.id === 'tab-' + btn.dataset.tab));
      setNavPadding();
    });

    /* Members */
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('addMemberBtn').addEventListener('click', async () => {
        const inp = document.getElementById('newMemberName'); const name = inp.value.trim();
        if (!name) return inp.reportValidity();
        showBusy(true);
        try { await API.addMember({ name }); inp.value = ''; await refreshAndRender(); }
        catch (e) { console.error(e); alert('הוספה נכשלה'); }
        finally { showBusy(false); }
      });
    });

    /* Init Guard */
    (async function guardAdmin() {
      try {
        const me = await API.me();
        if (!me?.success || me.role !== 'admin') { location.href = 'home.html?denied=1'; return; }
        window.gIsAdmin = true; window.gDisplayName = me.displayName || me.username || '';
        await refreshAndRender();
      } catch (e) {
        console.error('admin guard error:', e);
        alert('admin guard error: ' + e.message); // זמני לבדיקה
        // location.href='home.html?err=auth'; // תבטל זמנית
      }
      finally {
        document.getElementById('loader').style.display = 'none';
        document.getElementById('page').style.display = 'block';
        setNavPadding();
      }
    })();
  </script>
</body>

</html>