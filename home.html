<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>📋 אירועים</title>

  <!-- No-Cache -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="assets/css/styles.css" />
  <style>
    html,
    body {
      height: auto;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    body {
      background: #121212;
      color: #ccc;
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      text-align: center;
    }

    header.topbar {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f1c40f;
      color: #000;
      font-weight: bold;
      padding: 15px;
      font-size: 1.6em;
      border-bottom: 2px solid #333;
    }

    #greet {
      position: absolute;
      inset-inline-start: 8px;
      top: 50%;
      transform: translateY(-50%);
      max-width: 42vw;
      font-size: clamp(.75rem, 2.6vw, .95rem);
      color: #000;
      opacity: .9;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .topbar {
      flex-wrap: wrap;
    }

    #greet.multiline {
      position: static;
      inset: auto;
      transform: none;
      flex: 1 1 100%;
      text-align: center;
      margin-top: 4px;
      max-width: 100%;
      white-space: normal;
      overflow-wrap: anywhere;
      text-wrap: balance;
      font-size: clamp(.70rem, 2.2vw, .95rem);
    }

    .container {
      padding: 15px;
      max-width: 520px;
      margin: auto;
      text-align: right;
      padding-bottom: calc(var(--nav-h, 64px) + env(safe-area-inset-bottom, 0px));
    }

    .task-card {
      background: #1f1f1f;
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 14px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .35);
      text-align: right;
      border: 1px solid #2b2b2b;
    }

    .task-title {
      font-size: 1.25em;
      font-weight: 700;
      margin-bottom: 6px;
      color: #f1c40f;
    }

    .task-meta {
      font-size: 1em;
      color: #ddd;
      margin-bottom: 8px;
    }

    .task-notes {
      margin-top: 6px;
      color: #f1c40f;
      background: rgba(241, 196, 15, .08);
      border: 1px dashed rgba(241, 196, 15, .35);
      padding: 6px 8px;
      border-radius: 6px;
      font-size: .95em;
      line-height: 1.35;
      white-space: pre-wrap;
    }

    .btn {
      background: #f1c40f;
      border: none;
      padding: 8px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.05em;
      margin-top: 8px;
      color: #000;
      font-weight: 700;
    }

    .btn-secondary {
      background: #2c2c2c;
      color: #eee;
    }

    .btn-icon {
      padding: 6px 10px;
      font-size: .95em;
      line-height: 1;
      border-radius: 8px;
      width: auto;
      min-width: 0;
      background: #333;
      color: #fff;
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .resp-wrap {
      margin-top: 10px;
      border-top: 1px solid #333;
      padding-top: 10px;
    }

    .resp-header {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .resp-body {
      display: none;
      background: #151515;
      border: 1px solid #2a2a2a;
      border-radius: 10px;
      padding: 10px;
      margin-top: 8px;
    }

    .resp-open .resp-body {
      display: block;
    }

    .resp-title {
      color: #f1c40f;
      font-weight: 700;
      margin: 0 0 6px 0;
    }

    .resp-list {
      font-size: .85em;
      line-height: 1.28;
    }

    .resp-list section {
      margin-bottom: 6px;
    }

    .resp-list .h {
      margin: 0 0 2px 0;
    }

    .resp-list ol {
      margin: 2px 0 6px 0;
      padding-left: 20px;
    }

    .resp-list li {
      margin-bottom: 2px;
    }

    #loader {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #121212;
    }

    .loader {
      border: 6px solid #333;
      border-top: 6px solid #f1c40f;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin .7s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg)
      }
    }

    .bottom-nav .nav-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      text-align: center;
    }

    .nav-btn.is-disabled {
      opacity: .45;
      pointer-events: none;
      filter: grayscale(.2);
    }
  </style>
</head>

<body>
  <!-- Loader -->
  <div id="loader">
    <div class="loader"></div>
  </div>

  <!-- Topbar -->
  <header class="topbar">📋 אירועים <span id="greet"></span></header>

  <!-- Page -->
  <div id="page" style="display:none;">
    <main class="container" id="taskList"></main>
  </div>

  <!-- Spacer -->
  <div id="nav-spacer" aria-hidden="true"></div>

  <!-- Bottom nav -->
  <div class="bottom-nav" id="bottomNav">
    <button class="nav-btn" onclick="location.href='home.html'">🏠 בית</button>
    <button class="nav-btn" data-admin>⚙️ ניהול</button>
    <button class="nav-btn" data-logout title="יציאה">🚪 יציאה</button>
  </div>

  <script>
    function setNavPadding() {
      const nav = document.getElementById('bottomNav'); if (!nav) return;
      const h = Math.ceil(nav.getBoundingClientRect().height);
      document.documentElement.style.setProperty('--nav-h', h + 'px');
      const spacer = document.getElementById('nav-spacer');
      if (spacer) spacer.style.height = `calc(${h}px + env(safe-area-inset-bottom, 0px))`;
    }
    addEventListener('DOMContentLoaded', setNavPadding);
    addEventListener('resize', setNavPadding);
    addEventListener('orientationchange', setNavPadding);
  </script>

  <script src="assets/js/api.js?v=9"></script>
  <script>
    let gIsAdmin = false, gDisplayName = '';

    async function fetchInitData() { return API.getInitData(); }

    /* ===== Utils ===== */
    const esc = s => String(s).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\"/g, "&quot;").replace(/'/g, "&#039;");
    const truncate = (str, max = 200) => { if (!str) return ""; const s = String(str); return s.length > max ? s.slice(0, max - 1) + "…" : s; };
    const normDate = x => { const s = String(x || '').trim(); if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s; const d = new Date(s); return isNaN(d) ? s : d.toISOString().slice(0, 10); };
    const normTime = x => { const s = String(x || '').trim(); const m = s.match(/^(\d{1,2}):(\d{2})/); return m ? (('0' + m[1]).slice(-2)) + ':' + m[2] : ''; };
    const formatDate = v => { const d = new Date(v); return isNaN(d) ? v : d.toLocaleDateString('he-IL', { year: 'numeric', month: '2-digit', day: '2-digit' }); };
    const formatTime = v => { const t = new Date(v); if (!isNaN(t)) return t.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }); if (/^\d{1,2}:\d{2}$/.test(v)) return v; return v || ''; };
    const hebDayName = v => { const d = new Date(v); const days = ['ראשון', 'שני', 'שלישי', 'רביעי', 'חמישי', 'שישי', 'שבת']; return isNaN(d) ? '' : days[d.getDay()]; };

    /* ===== Group + Counts ===== */
    function groupResponsesForTask(taskObj, data, opts = {}) {
      const showNames = !!opts.showNames;
      const tTask = String(taskObj.משימה || '').trim();

      const allMembers = (data.members || [])
        .map(m => typeof m === 'string' ? m : (m.display_name || m.username || ''))
        .map(s => String(s).trim())
        .filter(Boolean);

      const responses = showNames ? (data.responses || []) : [];
      const summary = data.responseCounts || [];

      const grouped = {};
      const countsOnly = {};
      const responded = new Set();

      if (showNames) {
        responses.forEach(r => {
          if (r.משימה !== tTask) return;
          const status = String(r.סטטוס || '').trim();
          const name = String(r.שם || '').trim();
          const note = String(r.הערה || '').trim();
          if (!status || !name) return;
          responded.add(name);
          const label = note ? `${name} – ${note}` : name;
          (grouped[status] ||= []).push(label);
        });
      }

      if (!showNames) {
        summary
          .filter(s => s["משימה"] === taskObj.משימה && s["תאריך"] === taskObj.תאריך && s["שעה"] === taskObj.שעה)
          .forEach(s => { countsOnly[s["סטטוס"]] = Number(s.count); });
      } else {
        Object.entries(grouped).forEach(([k, arr]) => { countsOnly[k] = arr.length; });
      }

      let notResponded = [];
      if (showNames) {
        notResponded = allMembers.filter(m => !responded.has(m));
      } else {
        const totalAnswered = Object.values(countsOnly).reduce((a, b) => a + b, 0);
        const missing = Math.max(0, allMembers.length - totalAnswered);
        notResponded = Array(missing).fill('');
      }

      return { grouped, countsOnly, notResponded };
    }

    function compressCounts(countsOnly) {
      let arrive = 0, notArrive = 0;
      for (const [k, v] of Object.entries(countsOnly)) {
        const key = String(k);
        const isNo = key.includes('לא מגיע') || key.trim().startsWith('❌');
        if (isNo) notArrive += Number(v || 0);
        else arrive += Number(v || 0);
      }
      return { arrive, notArrive };
    }

    /* ===== Share Text ===== */
    function makeShareText(taskObj, grouped, notResponded, countsOnly, { includeNames = false } = {}) {
      const title = `${taskObj.משימה} • ${formatDate(taskObj.תאריך)} • ${formatTime(taskObj.שעה)} • ${hebDayName(taskObj.תאריך)}`;
      const lines = [`*${title}*`, ''];

      let i = 1;
      if (includeNames) {
        Object.entries(grouped).forEach(([k, arr]) => {
          if (arr.length) {
            lines.push(`*${k}:*`);
            arr.forEach(n => lines.push(`${i++}. ${n}`));
            lines.push('');
          }
        });

        if (notResponded.length) {
          lines.push('*לא הגיבו ❓:*');
          notResponded.forEach(n => lines.push(`${i++}. ${n}`));
          lines.push('');
        }
      }

      lines.push('*סיכום:*');
      Object.keys(countsOnly).forEach(k => lines.push(`- סה"כ ${k}: ${countsOnly[k]}`));
      lines.push(`- סה"כ לא הגיבו: ${notResponded.length}`);

      return lines.join("\n");
    }

    function renderResponsesBlock(taskObj, grouped, countsOnly, idx, notResponded) {
      const isAdmin = gIsAdmin;
      const title = `${taskObj.משימה} • ${formatDate(taskObj.תאריך)} • ${formatTime(taskObj.שעה)} • ${hebDayName(taskObj.תאריך)}`;
      const wrapId = `resp_${idx}`;
      const shareText = makeShareText(taskObj, grouped, notResponded, countsOnly, { includeNames: isAdmin });

      let sections = '';
      if (isAdmin) {
        // מציג רשימות רק לאדמין
        let counter = 1;
        Object.keys(grouped).sort((a, b) => a.localeCompare(b, 'he')).forEach(k => {
          const arr = grouped[k] || [];
          if (!arr.length) return;
          sections += `<section><div class="h"><b>${esc(k)}:</b></div><ol start="${counter}">${arr.map(n => `<li>${esc(n)}</li>`).join('')}</ol></section>`;
          counter += arr.length;
        });
        if (notResponded.length) {
          sections += `<section><div class="h"><b>לא הגיבו ❓:</b> (${notResponded.length})</div><ol start="${counter}">${notResponded.map(n => `<li>${esc(n)}</li>`).join('')}</ol></section>`;
        }
      }

      // === סיכום משותף לשני המצבים ===
      let summaryHtml = Object.entries(countsOnly)
        .sort(([a], [b]) => a.localeCompare(b, 'he'))
        .map(([k, v]) => `<div class="h"><b>סה"כ ${esc(k)}:</b> ${v}</div>`)
        .join('');
      summaryHtml += `<div class="h"><b>סה"כ לא הגיבו:</b> ${notResponded.length}</div>`;

      return `
    <div class="resp-wrap" id="${wrapId}">
      <div class="resp-header">
        <button class="btn btn-secondary resp-toggle" onclick="toggleResp('${wrapId}')">▶️ רשימה</button>
        <button class="btn btn-icon" onclick="copyShare('${encodeURIComponent(shareText)}')" title="העתק">📋</button>
      </div>
      <div class="resp-body">
        <div class="resp-title">${esc(title)}</div>
        <div class="resp-list">
          ${sections}
          <section>${summaryHtml}</section>
        </div>
      </div>
    </div>`;
    }


    function toggleResp(id) {
      const el = document.getElementById(id); if (!el) return;
      el.classList.toggle('resp-open');
      const btn = el.querySelector('.resp-toggle');
      if (btn) btn.textContent = el.classList.contains('resp-open') ? '🔽 רשימה' : '▶️ רשימה';
    }

    async function copyShare(encoded) {
      const txt = decodeURIComponent(encoded);
      try { await navigator.clipboard.writeText(txt); alert('הועתק ללוח'); }
      catch {
        const ta = document.createElement('textarea'); ta.value = txt; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); ta.remove(); alert('הועתק ללוח (fallback)');
      }
    }

    function openRespond(encTask, encDate, encTime) {
      location.href = `respond.html?task=${encTask}&date=${encDate}&time=${encTime}`;
    }

    /* ===== Load & Render ===== */
    async function loadTasks() {
      const list = document.getElementById('taskList');
      try {
        const data = await fetchInitData();
        if (data?.role) gIsAdmin = (String(data.role).toLowerCase() === 'admin');

        const tasks = (data.tasks || []).slice().reverse();
        if (!tasks.length) {
          list.innerHTML = '<p style="text-align:center;color:#aaa;">אין אירועים זמינים</p>';
        } else {
          list.innerHTML = tasks.map((t, i) => {
            const notes = t.דגשים ? `<div class="task-notes">📌 ${esc(truncate(t.דגשים, 220))}</div>` : '';
            const { grouped, countsOnly, notResponded } = groupResponsesForTask(t, data, { showNames: gIsAdmin });
            const respBlock = renderResponsesBlock(t, grouped, countsOnly, i, notResponded);
            const encTask = encodeURIComponent(t.משימה);
            const encDate = encodeURIComponent(t.תאריך);
            const encTime = encodeURIComponent(t.שעה);
            return `
            <div class="task-card">
              <div class="task-title">${i + 1}. ${esc(t.משימה)}</div>
              <div class="task-meta">${formatDate(t.תאריך)} • ${hebDayName(t.תאריך)} • שעה ${formatTime(t.שעה)}</div>
              ${notes}
              <div class="actions">
                <button class="btn" onclick="openRespond('${encTask}','${encDate}','${encTime}')">פתח</button>
              </div>
              ${respBlock}
            </div>`;
          }).join('');
        }
      } catch (err) {
        console.error(err);
        if (list) list.innerHTML = '<p style="color:red;text-align:center;">שגיאה בטעינת אירועים</p>';
      } finally {
        document.getElementById('loader').style.display = 'none';
        document.getElementById('page').style.display = 'block';
        setNavPadding();
      }
    }

    async function initAuthAndUI() {
      try {
        const me = await API.me();
        if (me?.success) {
          gIsAdmin = (me.role === 'admin');
          gDisplayName = me.displayName || me.username || '';
        }
      } catch { }

      const greetEl = document.getElementById('greet');
      if (greetEl) {
        greetEl.textContent = gDisplayName ? `ברוך הבא ${gDisplayName}${gIsAdmin ? ' – מנהל' : ''}` : '';
      }

      const adminBtn = document.querySelector('.bottom-nav .nav-btn[data-admin]');
      if (adminBtn) {
        if (!gIsAdmin) {
          adminBtn.classList.add('is-disabled'); adminBtn.disabled = true; adminBtn.title = 'למנהלים בלבד';
        } else {
          adminBtn.classList.remove('is-disabled'); adminBtn.disabled = false;
          if (!adminBtn._wired) { adminBtn.addEventListener('click', () => location.href = 'admin.html'); adminBtn._wired = true; }
        }
      }

      const logoutBtn = document.querySelector('.bottom-nav .nav-btn[data-logout]');
      if (logoutBtn) {
        const hasToken = !!(API?.Auth?.token || localStorage.getItem('token'));
        logoutBtn.style.display = hasToken ? 'inline-flex' : 'none';
        if (!logoutBtn._wired) {
          logoutBtn.addEventListener('click', async () => { try { await API.logout(); } catch { } location.href = 'index.html?force=1'; });
          logoutBtn._wired = true;
        }
      }

      await loadTasks();
    }

    initAuthAndUI();
  </script>